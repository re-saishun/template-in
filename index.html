<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEMPLATE-IN Pro | Real-time Interactive</title>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #3b82f6; --bg: #0f172a; --card: #1e293b; --accent: #10b981; }
        body { margin: 0; font-family: 'League Spartan', sans-serif; background: var(--bg); color: white; height: 100vh; display: flex; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 350px; background: #111827; padding: 20px; overflow-y: auto; border-right: 1px solid #334155; z-index: 1000; }
        .preview-container { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; gap: 40px; background: #1e293b; position: relative; }

        /* CANVAS STYLES */
        .page-wrapper { position: relative; background: white; line-height: 0; box-shadow: 0 20px 50px rgba(0,0,0,0.5); user-select: none; }
        .template-frame { position: relative; z-index: 2; width: 500px; pointer-events: none; }
        
        /* INTERACTIVE ELEMENTS */
        .layer { position: absolute; inset: 0; }
        .z-back { z-index: 1; }
        .z-front { z-index: 5; }

        /* Draggable Element Box */
        .editable {
            position: absolute; cursor: move; border: 2px transparent dashed;
            display: flex; align-items: center; justify-content: center;
            pointer-events: all !important;
        }
        .editable:hover, .editable.active { border-color: var(--primary); }

        .user-image { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        .text-element { width: 100%; text-align: center; color: black; font-weight: 700; pointer-events: none; white-space: pre-wrap; }

        /* CONTROLS HANDLES */
        .handle { 
            position: absolute; width: 12px; height: 12px; background: white; 
            border: 2px solid var(--primary); border-radius: 50%; display: none;
        }
        .editable.active .handle { display: block; }
        .h-resizer { right: -6px; bottom: -6px; cursor: nwse-resize; }
        .h-rotator { top: -25px; left: 50%; transform: translateX(-50%); cursor: grab; background: var(--accent); }

        /* EXPORT MODAL */
        #export-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .export-box { background: var(--card); padding: 30px; border-radius: 15px; width: 300px; text-align: center; }

        /* UI */
        .control-group { background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #334155; }
        textarea { width: 100%; height: 60px; background: #0f172a; color: white; border: 1px solid #475569; border-radius: 5px; padding: 8px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; }
    </style>
</head>
<body>

<div id="export-modal">
    <div class="export-box">
        <h3>PILIH FORMAT</h3>
        <button class="btn" style="background:var(--primary)" onclick="processExport('pdf')">PDF (High Quality)</button>
        <button class="btn" style="background:var(--accent)" onclick="processExport('png')">PNG (Batch)</button>
        <button class="btn" style="background:#ef4444" onclick="closeExport()">BATAL</button>
    </div>
</div>

<div class="sidebar">
    <h2 style="text-align:center; color:var(--primary)">REAL-TIME EDITOR</h2>
    <p style="font-size: 11px; color: #94a3b8; text-align: center;">Klik & Geser elemen di kanan untuk memindahkan, menarik sudut untuk zoom, dan titik hijau untuk rotasi.</p>
    
    <div id="sidebar-controls">
        <div class="control-group">
            <h3>PAGE 1</h3>
            <textarea oninput="updateLiveText('txt-p1', this.value)">HEADLINE BERITA</textarea>
            <label>Ganti Background</label>
            <input type="file" onchange="uploadToElement(this, 'img-p1')">
        </div>
    </div>

    <button class="btn" style="background:var(--accent)" onclick="addNewPage()">+ TAMBAH HALAMAN</button>
    <button class="btn" style="background:var(--primary)" onclick="openExport()">EXPORT DESIGN</button>
</div>

<div class="preview-container" id="preview-list">
    <div class="page-wrapper" id="page-1">
        <div class="layer z-back">
            <div class="editable active" id="box-img-p1" style="width: 500px; height: 500px; left: 0; top: 0;">
                <img id="img-p1" class="user-image" src="">
                <div class="handle h-resizer"></div>
                <div class="handle h-rotator"></div>
            </div>
        </div>
        <img src="template/news1.png" class="template-frame">
        <div class="layer z-front">
            <div class="editable" id="box-txt-p1" style="width: 400px; left: 50px; top: 250px;">
                <div id="txt-p1" class="text-element" style="font-size: 40px;">HEADLINE BERITA</div>
                <div class="handle h-resizer"></div>
                <div class="handle h-rotator"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let pageCount = 1;
    let activeEl = null;
    let isDragging = false, isResizing = false, isRotating = false;
    let startX, startY, startW, startH, startAngle;

    // --- INTERACTIVE ENGINE ---
    function initInteract(el) {
        el.addEventListener('mousedown', (e) => {
            // Hilangkan status aktif dari elemen lain
            document.querySelectorAll('.editable').forEach(box => box.classList.remove('active'));
            el.classList.add('active');
            activeEl = el;

            const handle = e.target;
            const rect = el.getBoundingClientRect();

            if (handle.classList.contains('h-resizer')) {
                isResizing = true;
            } else if (handle.classList.contains('h-rotator')) {
                isRotating = true;
                const center = getCenter(el);
                startAngle = Math.atan2(e.clientY - center.y, e.clientX - center.x) - getRotation(el);
            } else {
                isDragging = true;
                startX = e.clientX - el.offsetLeft;
                startY = e.clientY - el.offsetTop;
            }
            e.stopPropagation();
        });
    }

    document.addEventListener('mousemove', (e) => {
        if (!activeEl) return;

        if (isDragging) {
            activeEl.style.left = (e.clientX - startX) + 'px';
            activeEl.style.top = (e.clientY - startY) + 'px';
        } 
        else if (isResizing) {
            const rect = activeEl.getBoundingClientRect();
            activeEl.style.width = (e.clientX - rect.left) + 'px';
            // Jika itu teks, biarkan height auto, jika gambar bisa set height
            if(activeEl.querySelector('img')) activeEl.style.height = (e.clientY - rect.top) + 'px';
        }
        else if (isRotating) {
            const center = getCenter(activeEl);
            const angle = Math.atan2(e.clientY - center.y, e.clientX - center.x);
            const rotation = (angle - startAngle) * (180 / Math.PI);
            activeEl.style.transform = `rotate(${rotation}deg)`;
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = isResizing = isRotating = false;
    });

    function getCenter(el) {
        const rect = el.getBoundingClientRect();
        return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
    }

    function getRotation(el) {
        const st = window.getComputedStyle(el, null);
        const tr = st.getPropertyValue("transform");
        if (tr === "none") return 0;
        const values = tr.split('(')[1].split(')')[0].split(',');
        return Math.atan2(values[1], values[0]);
    }

    // --- LOGIC EDITOR ---
    function uploadToElement(input, targetImgId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById(targetImgId);
                img.src = e.target.result;
                img.parentElement.style.display = "flex";
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function updateLiveText(id, val) { document.getElementById(id).innerText = val; }

    function addNewPage() {
        pageCount++;
        const p = pageCount;
        const temp = (p % 2 === 0) ? 'news2.jpg' : 'news3.jpg';

        // Sidebar
        const ctrl = document.createElement('div');
        ctrl.className = 'control-group';
        ctrl.innerHTML = `<h3>PAGE ${p}</h3>
            <textarea oninput="updateLiveText('txt-p${p}', this.value)" placeholder="Teks hal ${p}"></textarea>
            <input type="file" onchange="uploadToElement(this, 'img-p${p}')">`;
        document.getElementById('sidebar-controls').appendChild(ctrl);

        // Preview
        const wrap = document.createElement('div');
        wrap.className = 'page-wrapper';
        wrap.id = `page-${p}`;
        wrap.innerHTML = `
            <img src="template/${temp}" class="template-frame">
            <div class="layer z-front">
                <div class="editable" id="box-img-p${p}" style="width:200px; height:200px; left:150px; top:200px; display:none;">
                    <img id="img-p${p}" class="user-image" src="">
                    <div class="handle h-resizer"></div>
                    <div class="handle h-rotator"></div>
                </div>
                <div class="editable" id="box-txt-p${p}" style="width:300px; left:100px; top:100px;">
                    <div id="txt-p${p}" class="text-element" style="font-size:20px;">Tulis narasi di sini...</div>
                    <div class="handle h-resizer"></div>
                    <div class="handle h-rotator"></div>
                </div>
            </div>`;
        document.getElementById('preview-list').appendChild(wrap);
        
        // Init Interaction for new elements
        initInteract(document.getElementById(`box-img-p${p}`));
        initInteract(document.getElementById(`box-txt-p${p}`));
    }

    // --- EXPORT ---
    function openExport() { document.getElementById('export-modal').style.display = 'flex'; }
    function closeExport() { document.getElementById('export-modal').style.display = 'none'; }

    async function processExport(format) {
        // Hilangkan border aktif sebelum capture
        document.querySelectorAll('.editable').forEach(box => box.classList.remove('active'));
        closeExport();
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');

        for(let i=1; i<=pageCount; i++) {
            const canvas = await html2canvas(document.getElementById(`page-${i}`), { scale: 2, useCORS: true });
            if (format === 'pdf') {
                if (i > 1) pdf.addPage();
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, 210, 297);
            } else {
                const link = document.createElement('a');
                link.download = `Page-${i}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }
        }
        if (format === 'pdf') pdf.save('Sakatimes_Design.pdf');
    }

    // Init Page 1
    initInteract(document.getElementById('box-img-p1'));
    initInteract(document.getElementById('box-txt-p1'));
</script>

</body>
</html>
