<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TEMPLATE-IN Pro | Professional Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #3b82f6; --bg: #0f172a; --card: #1e293b; --accent: #10b981; --border: #334155; }
        body { margin: 0; font-family: 'League Spartan', sans-serif; background: var(--bg); color: white; height: 100vh; display: flex; overflow: hidden; touch-action: manipulation; }

        /* Auth Overlay */
        #auth-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .modal { background: var(--card); padding: 40px; border-radius: 20px; width: 350px; text-align: center; border: 1px solid var(--border); }
        .modal select, .modal input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #475569; background: #0f172a; color: white; box-sizing: border-box; }
        .modal button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }

        /* Layout Utama */
        #main-app { display: none; width: 100%; height: 100vh; flex-direction: row; }
        
        /* Sidebar & Menu Mobile */
        #menu-toggle { position: fixed; top: 15px; left: 15px; z-index: 1000; background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 20px; cursor: pointer; display: none; }
        #sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 998; display: none; }

        .sidebar { width: 360px; background: #111827; padding: 25px; overflow-y: auto; border-right: 1px solid var(--border); transition: 0.3s ease; }
        .preview-container { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; background: #0f172a; -webkit-overflow-scrolling: touch; }

        /* Canvas Page */
        .page-wrapper { position: relative; width: 500px; background: white; overflow: hidden; box-shadow: 0 40px 100px rgba(0,0,0,0.6); flex-shrink: 0; margin-bottom: 40px; }
        .template-frame { position: absolute; top: 0; left: 0; width: 100%; z-index: 5; pointer-events: none; }        
        .layer-manager { position: absolute; inset: 0; z-index: auto; } 

        /* Elements */
        .editable { position: absolute; cursor: move; border: 1.5px dashed transparent; display: flex; align-items: center; justify-content: center; touch-action: none; user-select: none; }
        .editable.active { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); z-index: 100 !important; }
        .user-image { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        .text-element { width: 100%; text-align: center; color: black; font-weight: 700; pointer-events: none; white-space: pre-wrap; line-height: 1.1; }

        /* Controls */
        .handle { position: absolute; width: 24px; height: 24px; background: white; border: 2px solid var(--primary); border-radius: 50%; display: none; z-index: 101; }
        .editable.active .handle { display: block; }
        .h-resizer { right: -12px; bottom: -12px; cursor: nwse-resize; }
        .h-rotator { top: -45px; left: 50%; transform: translateX(-50%); cursor: grab; background: var(--accent); border-color: white; }

        .control-group { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border); }
        label { display: block; margin: 10px 0 5px; font-size: 11px; color: #94a3b8; font-weight: bold; }
        textarea { width: 100%; height: 60px; background: #0f172a; color: white; border: 1px solid var(--border); border-radius: 6px; padding: 10px; resize: none; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; }
        .btn-sm { padding: 8px; font-size: 10px; margin-top: 5px; background: #475569; }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            #menu-toggle { display: block; }
            .sidebar { position: fixed; left: -360px; top: 0; bottom: 0; z-index: 999; width: 300px; }
            .sidebar.open { left: 0; }
            #sidebar-overlay.active { display: block; }
            .preview-container { padding: 80px 10px 20px 10px; }
            .page-wrapper { width: 95vw; }
        }
    </style>
</head>
<body>

<button id="menu-toggle" onclick="toggleSidebar()">â˜°</button>
<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="auth-overlay">
    <div class="modal">
        <h2 style="color:var(--primary)">TEMPLATE-IN PRO</h2>
        <select id="auth-category">
            <option value="SAKATIMES">SAKATIMES</option>
            <option value="MAJALAH">MAJALAH</option>
        </select>
        <input type="password" id="auth-code" placeholder="KODE AKSES">
        <button onclick="checkAccess()">LOG IN EDITOR</button>
        <p id="auth-status" style="font-size: 10px; color: #64748b; margin-top: 15px;">Mengecek Konfigurasi...</p>
    </div>
</div>

<div id="main-app">
    <div class="sidebar">
        <h2 style="text-align:center; color:var(--primary); font-size: 18px;">EDITOR PANEL</h2>
        <div id="sidebar-controls"></div>
        <button class="btn" style="background: var(--accent)" onclick="addNewPage()">+ TAMBAH HALAMAN</button>
        <button class="btn" style="background: var(--primary)" onclick="openExport()">DOWNLOAD HASIL</button>
    </div>
    <div class="preview-container" id="preview-list"></div>
</div>

<div id="export-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; z-index:10000; justify-content:center; align-items:center;">
    <div style="background:var(--card); padding:30px; border-radius:20px; text-align:center; border: 1px solid var(--border);">
        <h3>EKSPOR DESAIN</h3>
        <button class="btn" style="background:var(--primary)" onclick="processExport('pdf')">SIMPAN PDF</button>
        <button class="btn" style="background:#6366f1" onclick="processExport('png')">SIMPAN PNG</button>
        <br><br>
        <button class="btn" style="background:transparent; border:1px solid #ff4444; color:#ff4444" onclick="closeExport()">BATAL</button>
    </div>
</div>

<script>
    let configData = { "templates": [] };
    let currentSession = null;
    let pageCount = 0;
    let imgCounter = 0;

    fetch('config.json').then(r => r.json()).then(d => { 
        configData = d; 
        document.getElementById('auth-status').innerText = "Config Synced."; 
    });

    function toggleSidebar() {
        document.querySelector('.sidebar').classList.toggle('open');
        document.getElementById('sidebar-overlay').classList.toggle('active');
    }

    function checkAccess() {
        const cat = document.getElementById('auth-category').value;
        const code = document.getElementById('auth-code').value;
        const found = configData.templates.find(t => t.category === cat && t.code === code);
        if (found) {
            currentSession = found;
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            setupFirstPage();
        } else { alert("Kode Akses Salah!"); }
    }

    function autoScaleCanvas(pageId) {
        const wrapper = document.getElementById(pageId);
        const img = wrapper.querySelector('.template-frame');
        const adjust = () => {
            const currentWidth = wrapper.offsetWidth;
            const ratio = img.naturalHeight / img.naturalWidth;
            wrapper.style.height = (currentWidth * ratio) + "px";
        };
        if (img.complete) adjust(); else img.onload = adjust;
    }

    function setupFirstPage() {
        pageCount = 1;
        const templateFile = currentSession.files[0];
        
        const ctrl = document.createElement('div');
        ctrl.className = 'control-group';
        ctrl.innerHTML = `
            <h3 style="font-size:14px; color:var(--accent)">PAGE 1 (COVER)</h3>
            <label>Headline</label>
            <textarea oninput="updateLiveText('txt-p1', this.value)">HEADLINE BERITA UTAMA</textarea>
            <label>Foto Cover</label>
            <input type="file" onchange="uploadToElement(this, 'img-p1', 'box-img-p1')">`;
        document.getElementById('sidebar-controls').appendChild(ctrl);

        const wrap = document.createElement('div');
        wrap.className = 'page-wrapper'; wrap.id = `page-1`;
        wrap.innerHTML = `
            <div class="layer-manager">
                <div class="editable active" id="box-img-p1" style="width: 500px; height: 500px; left: 0; top: 0; z-index: 10;">
                    <img id="img-p1" class="user-image" src="https://via.placeholder.com/500?text=Upload+Cover">
                    <div class="handle h-resizer"></div><div class="handle h-rotator"></div>
                </div>
            </div>
            <img src="template/${templateFile}" class="template-frame">
            <div class="layer-manager">
                <div class="editable" id="box-txt-p1" style="width: 440px; left: 30px; top: 300px; z-index: 15;">
                    <div id="txt-p1" class="text-element" style="font-size: 40px; color: black;">HEADLINE BERITA UTAMA</div>
                    <div class="handle h-resizer"></div><div class="handle h-rotator"></div>
                </div>
            </div>`;
        document.getElementById('preview-list').appendChild(wrap);
        initInteract(document.getElementById('box-img-p1'));
        initInteract(document.getElementById('box-txt-p1'));
        autoScaleCanvas('page-1');
    }

    function addNewPage() {
        pageCount++;
        const p = pageCount;
        const totalTemplates = currentSession.files.length;
        
        let fileIdx = (totalTemplates > 1) ? ((p - 2) % (totalTemplates - 1)) + 1 : 0;
        const templateFile = currentSession.files[fileIdx];

        const ctrl = document.createElement('div');
        ctrl.className = 'control-group';
        ctrl.id = `ctrl-p${p}`;
        ctrl.innerHTML = `<h3>PAGE ${p}</h3>
            <label>Teks</label><textarea oninput="updateLiveText('txt-p${p}', this.value)"></textarea>
            <div id="img-inputs-p${p}">
                <label>Foto 1</label>
                <input type="file" onchange="uploadToElement(this, 'img-p${p}-1', 'box-img-p${p}-1')">
            </div>
            <button class="btn btn-sm" onclick="addExtraPhoto(${p})">+ Tambah Foto Lainnya</button>`;
        document.getElementById('sidebar-controls').appendChild(ctrl);

        const wrap = document.createElement('div');
        wrap.className = 'page-wrapper'; wrap.id = `page-${p}`;
        wrap.innerHTML = `
            <img src="template/${templateFile}" class="template-frame">
            <div class="layer-manager" id="photo-layer-p${p}">
                <div class="editable" id="box-img-p${p}-1" style="width:250px; height:250px; left:125px; top:150px; display:none; z-index:10;">
                    <img id="img-p${p}-1" class="user-image">
                    <div class="handle h-resizer"></div><div class="handle h-rotator"></div>
                </div>
            </div>
            <div class="layer-manager">
                <div class="editable" id="box-txt-p${p}" style="width:400px; left:50px; top:50px; z-index:15;">
                    <div id="txt-p${p}" class="text-element" style="font-size:22px;">Isi teks halaman ${p}...</div>
                    <div class="handle h-resizer"></div><div class="handle h-rotator"></div>
                </div>
            </div>`;
        document.getElementById('preview-list').appendChild(wrap);
        initInteract(wrap.querySelector(`#box-img-p${p}-1`));
        initInteract(wrap.querySelector(`#box-txt-p${p}`));
        autoScaleCanvas(`page-${p}`);
        
        if (window.innerWidth <= 768) toggleSidebar();
    }

    function addExtraPhoto(pageNum) {
        imgCounter++;
        const id = `extra-${imgCounter}`;
        const container = document.getElementById(`img-inputs-p${pageNum}`);
        const div = document.createElement('div');
        div.innerHTML = `<label>Foto Tambahan</label><input type="file" onchange="uploadToElement(this, 'img-${id}', 'box-img-${id}')">`;
        container.appendChild(div);

        const layer = document.getElementById(`photo-layer-p${pageNum}`);
        const el = document.createElement('div');
        el.className = 'editable'; el.id = `box-img-${id}`;
        el.style = "width:150px; height:150px; left:50px; top:50px; display:none; z-index:11;";
        el.innerHTML = `<img id="img-${id}" class="user-image"><div class="handle h-resizer"></div><div class="handle h-rotator"></div>`;
        layer.appendChild(el);
        initInteract(el);
    }

    function uploadToElement(input, targetImgId, boxId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById(targetImgId);
                const box = document.getElementById(boxId);
                const tempImg = new Image();
                tempImg.onload = function() {
                    const originalRatio = tempImg.height / tempImg.width;
                    const defaultWidth = 300; 
                    box.style.width = defaultWidth + "px";
                    box.style.height = (defaultWidth * originalRatio) + "px";
                    img.src = e.target.result;
                    box.style.display = "flex";
                };
                tempImg.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Interaction Engine (Smooth Mobile)
    let activeEl = null, isDragging = false, isResizing = false, isRotating = false;
    let startX, startY, startW, startH, startFontSize, startAngle;

    function initInteract(el) {
        el.addEventListener('mousedown', startInteract);
        el.addEventListener('touchstart', startInteract, {passive: false});
    }

    function startInteract(e) {
        const el = e.target.closest('.editable');
        if (!el) return;
        
        document.querySelectorAll('.editable').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        activeEl = el;

        const clientX = e.clientX || (e.touches ? e.touches[0].pageX : 0);
        const clientY = e.clientY || (e.touches ? e.touches[0].pageY : 0);

        if (e.target.classList.contains('h-resizer')) {
            isResizing = true; startW = el.offsetWidth; startH = el.offsetHeight;
            startX = clientX; startY = clientY;
            const txt = el.querySelector('.text-element');
            if(txt) startFontSize = parseFloat(window.getComputedStyle(txt).fontSize);
        } else if (e.target.classList.contains('h-rotator')) {
            isRotating = true; const center = getCenter(el);
            startAngle = Math.atan2(clientY - center.y, clientX - center.x) - getRotation(el);
        } else {
            isDragging = true; startX = clientX - el.offsetLeft; startY = clientY - el.offsetTop;
        }
    }

    function handleMove(e) {
        if (!activeEl) return;
        if (e.cancelable) e.preventDefault(); // Kunci scroll layar

        const clientX = e.clientX || (e.touches ? e.touches[0].pageX : 0);
        const clientY = e.clientY || (e.touches ? e.touches[0].pageY : 0);

        if (isDragging) {
            activeEl.style.left = (clientX - startX) + 'px';
            activeEl.style.top = (clientY - startY) + 'px';
        } else if (isResizing) {
            const newW = Math.max(20, startW + (clientX - startX));
            activeEl.style.width = newW + 'px';
            const txt = activeEl.querySelector('.text-element');
            if (txt) {
                txt.style.fontSize = (startFontSize * (newW / startW)) + 'px';
            } else {
                activeEl.style.height = (newW * (startH / startW)) + 'px';
            }
        } else if (isRotating) {
            const center = getCenter(activeEl);
            const angle = Math.atan2(clientY - center.y, clientX - center.x);
            activeEl.style.transform = `rotate(${(angle - startAngle) * (180/Math.PI)}deg)`;
        }
    }

    document.addEventListener('mousemove', handleMove);
    document.addEventListener('touchmove', handleMove, {passive: false});
    document.addEventListener('mouseup', () => isDragging = isResizing = isRotating = false);
    document.addEventListener('touchend', () => isDragging = isResizing = isRotating = false);

    function getCenter(el) { const r = el.getBoundingClientRect(); return { x: r.left + r.width/2, y: r.top + r.height/2 }; }
    function getRotation(el) {
        const st = window.getComputedStyle(el, null);
        const tr = st.getPropertyValue("transform");
        if (tr === "none") return 0;
        const v = tr.split('(')[1].split(')')[0].split(',');
        return Math.atan2(v[1], v[0]);
    }

    function updateLiveText(id, val) { document.getElementById(id).innerText = val; }
    function openExport() { document.getElementById('export-modal').style.display = 'flex'; }
    function closeExport() { document.getElementById('export-modal').style.display = 'none'; }

    async function processExport(format) {
        document.querySelectorAll('.editable').forEach(b => b.classList.remove('active'));
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        for(let i=1; i<=pageCount; i++) {
            const page = document.getElementById(`page-${i}`);
            const canvas = await html2canvas(page, { scale: 2, useCORS: true });
            if (format === 'pdf') {
                if (i > 1) pdf.addPage();
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 210, 297);
            } else {
                const link = document.createElement('a');
                link.download = `Page_${i}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        }
        if (format === 'pdf') pdf.save('Export_Desain.pdf');
        closeExport();
    }
</script>
</body>
</html>
